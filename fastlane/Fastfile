default_platform(:ios)

# Public lanes

desc "Run all tests"
lane :tests do
  run_macOS_tests
  run_iOS_tests
  run_tvOS_tests
end

desc "Run tests on CI"
lane :tests_ci do
  if ENV["DESTINATION"].include? "watchOS" then
    build(destination: ENV["DESTINATION"], swift_version: ENV["SWIFT_VERSION"], ENV["SCHEME"])
else
    test_ci(destination: ENV["DESTINATION"], swift_version: ENV["SWIFT_VERSION"], ENV["SCHEME"])
end

# Private lanes

private_lane :run_iOS_tests do
  scan(
    project: "WIPFoundation.xcodeproj",
    scheme: "WIPFoundation iOS"
  ) 
end

private_lane :run_tvOS_tests do
  scan(
    project: "WIPFoundation.xcodeproj", 
    scheme: "WIPFoundation tvOS"
  ) 
end

private_lane :run_macOS_tests do
  scan(
    project: "WIPFoundation.xcodeproj", 
    scheme: "WIPFoundation macOS"
  ) 
end

private_lane :test_ci do |options|
  scan(
    scheme: options[:scheme], 
    clean: true, 
    xcargs: "SWIFT_VERSION=#{options[:swift_version]}",
    destination: options[:destination]
  )
end

private lane :build do |options|
  gym(
    project: "WIPFoundation.xcodeproj",
    configuration: "Debug",
    scheme: options[:scheme],
    xcargs: "SWIFT_VERSION=#{options[:swift_version]}",
    destination: options[:destination]
  )
end
